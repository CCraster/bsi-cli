#!/usr/bin/env node
const program = require('commander');
const serve = require('serve-handler');
const url = require('url');
const chalk = require('chalk');
const os = require('os');
const path = require('path');
const http = require('http');
const portfinder = require('portfinder');

program.option('-p, --port <port>', 'which port to use', 9000);

program.parse(process.argv);
function parseUrl(hostname, port, bold = true, pathname = '/') {
  return url.format({
    protocol: 'http',
    hostname,
    port: bold ? chalk.bold(port) : port,
    pathname,
  });
}
function getIp() {
  const interfaces = os.networkInterfaces();
  for (const key of Object.keys(interfaces)) {
    for (const i of interfaces[key]) {
      if (i.family === 'IPv4' && !i.internal) {
        return i.address;
      }
    }
  }
}
function getPort(port) {
  return portfinder.getPortPromise({ port });
}

const dir = path.join(process.cwd(), program.args[0]) || process.cwd();

async function run() {
  const port = await getPort(program.port);
  const app = http.createServer((req, res) => {
    return serve(req, res, {
      public: dir,
    });
  });
  app.listen(port, () => {
    console.log();
    console.log(' ðŸŽ‰ App running at:');
    console.log(`  - Local:   ${chalk.cyan(parseUrl('localhost', port))}`);
    console.log(`  - Network: ${chalk.cyan(parseUrl(getIp(), port))}`);
    // if (open) {
    // await browser(parseUrl('localhost', serverPort, false));
    // }
  });
}
run();
